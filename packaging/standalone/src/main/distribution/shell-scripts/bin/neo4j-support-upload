#!/bin/bash
BUCKET='https://support-upload.neotechnology.com.s3.amazonaws.com'

die() {
  echo $1
  exit 1
}

action() {
  local message=$1
  local command=$2
  echo -n "${message} ..."
  eval $command || die "$command failed"
  echo "... done."

}

set -e

read -p "I need to know the ticket number that you're uploading the data store with: " ticket_number
[ -n "${ticket_number}" ] || die "Sorry, I really need that support ticket number"

read -p "THIS WILL UPLOAD ALL YOUR DATA TO A PRIVATE S3 BUCKET. Do you agree with this? (Y/N): " confirmation

shopt -s nocasematch
case "${confirmation}" in 
  y)
    echo "Ok. Starting the upload process in 10 seconds"
    sleep 1 #0
  ;;
  n)
    echo "OK. This script will exit and NOT upload your data"
    exit 0 
  ;;
  *)
    "I need to press you for an answer on that one"
    exit 1
  ;;

esac

script_dir=$(dirname $0)
data_dir="${script_dir}/../data"

data_file="${RANDOM}.${RANDOM}.${ticket_number}.tgz"

action "Stopping Neo4j" "./bin/neo4j stop"
action "Making an archive of your datastore and logs" "tar -czf ${data_file} ${data_dir}"
action "Uploading your datastore and logs to Neo Technology" "curl -T ${data_file} ${BUCKET}"
